<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.7.1/p5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.7.1/addons/p5.dom.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.js"></script>
    <script src="https://unpkg.com/qrcode-generator@1.4.4/qrcode.js"></script>
    <script src='js/jquery.js'> </script>
    <script src='js/config.js'> </script>
    <script src='js/nameGenerator.js'> </script>
    <script src='js/cursorGui.js'> </script>
    
    <!-- Agregando las fuentes de Google -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto&family=Montserrat&family=Lato&family=Open+Sans&family=Poppins&family=Dancing+Script&family=Pacifico&family=Indie+Flower&family=Shadows+Into+Light&family=Permanent+Marker&family=Caveat&family=Satisfy&family=Quicksand&family=Comfortaa&family=Josefin+Sans&display=swap" rel="stylesheet">
    
    <link rel='stylesheet' href='css/style.css' />
  </head>
  <body>
    <!-- Core libraries -->
    <script src="js/kaleidoscope.js"></script>
    <script src="js/analyticsTracker.js"></script>
    <script src="js/cursorserver.js"></script>
    <script src="js/config.js"></script>
    
    <!-- Brush System - New Architecture -->
    <script src="js/brushes/BaseBrush.js"></script>
    <script src="js/brushes/BrushRegistry.js"></script>
    
    <!-- Brush Implementations (Class-based) -->
    <script src="js/brushes/standardbrush.js"></script>
    <script src="js/brushes/pixelbrush.js"></script>
    <script src="js/brushes/artbrush.js"></script>
    <script src="js/brushes/linebrush.js"></script>
    <script src="js/brushes/textbrush.js"></script>
    <script src="js/brushes/geometrybrush.js"></script>
    <script src="js/brushes/fillbrush.js"></script>
    <script src="js/brushes/imagebrush.js"></script>
    <script src="js/brushes/flowerbrush.js"></script>
    
    <!-- Legacy brushes (COMENTADOS - ya migrados a clases) -->
    <!-- <script src="js/brushes/standardbrush.js"></script> -->
    <!-- <script src="js/brushes/pixelbrush.js"></script> -->
    <!-- <script src="js/brushes/artbrush.js"></script> -->
    <!-- <script src="js/brushes/linebrush.js"></script> -->
    <!-- <script src="js/brushes/textbrush.js"></script> -->
    <!-- <script src="js/brushes/geometrybrush.js"></script> -->
    <!-- <script src="js/brushes/fillbrush.js"></script> -->
    <!-- <script src="js/brushes/imagebrush.js"></script> -->
    
    <!-- Brush System Initialization -->
    <script src="js/brushes/init.js"></script>
    
    <!-- Image Search System -->
    <script src="js/imageSearch.js"></script>
    
    <!-- Main sketch (debe cargarse despu√©s de los brushes) -->
    <script src="js/sketch.js"></script>
    
    <div id="gui" >
        <!-- Men√∫ de pesta√±as -->
        <div class="tab-menu">
            <button class="tab-btn active" data-tab="drawing">Draw</button>
            <button class="tab-btn" data-tab="chat">Chat</button>
            <button class="tab-btn" data-tab="user">User</button>
            <button class="tab-btn" data-tab="about">Read</button>
        </div>
        
        <!-- Contenido de la pesta√±a: Interfaz de dibujo -->
        <div id="tab-drawing" class="tab-content active">
        <div class="color-palette-section" style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 12px; margin-bottom: 15px;">
            <label style="font-family: 'Poppins', sans-serif; font-weight: 600; font-size: 1.1rem; color: rgba(255,255,255,0.95); margin-bottom: 12px; display: block;">Color Palette</label>
            <div class="color-palette-slots" style="display: flex; gap: 10px; margin-bottom: 0;">
                <div class="palette-slot active" data-slot="0" style="width: 42px; height: 42px; border-radius: 10px; background-color: #FF0000; border: 3px solid white; cursor: pointer; position: relative; transition: all 0.2s ease; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">
                    <span style="position: absolute; bottom: -20px; left: 50%; transform: translateX(-50%); font-size: 11px; font-weight: 600; color: rgba(255,255,255,0.8); font-family: 'Poppins', sans-serif;">1</span>
                </div>
                <div class="palette-slot" data-slot="1" style="width: 42px; height: 42px; border-radius: 10px; background-color: #00FF00; border: 2px solid rgba(255,255,255,0.3); cursor: pointer; position: relative; transition: all 0.2s ease; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">
                    <span style="position: absolute; bottom: -20px; left: 50%; transform: translateX(-50%); font-size: 11px; font-weight: 600; color: rgba(255,255,255,0.8); font-family: 'Poppins', sans-serif;">2</span>
                </div>
                <div class="palette-slot" data-slot="2" style="width: 42px; height: 42px; border-radius: 10px; background-color: #0000FF; border: 2px solid rgba(255,255,255,0.3); cursor: pointer; position: relative; transition: all 0.2s ease; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">
                    <span style="position: absolute; bottom: -20px; left: 50%; transform: translateX(-50%); font-size: 11px; font-weight: 600; color: rgba(255,255,255,0.8); font-family: 'Poppins', sans-serif;">3</span>
                </div>
                <div class="palette-slot" data-slot="3" style="width: 42px; height: 42px; border-radius: 10px; background-color: #FFFF00; border: 2px solid rgba(255,255,255,0.3); cursor: pointer; position: relative; transition: all 0.2s ease; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">
                    <span style="position: absolute; bottom: -20px; left: 50%; transform: translateX(-50%); font-size: 11px; font-weight: 600; color: rgba(255,255,255,0.8); font-family: 'Poppins', sans-serif;">4</span>
                </div>
                <div class="palette-slot" data-slot="4" style="width: 42px; height: 42px; border-radius: 10px; background-color: #FF00FF; border: 2px solid rgba(255,255,255,0.3); cursor: pointer; position: relative; transition: all 0.2s ease; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">
                    <span style="position: absolute; bottom: -20px; left: 50%; transform: translateX(-50%); font-size: 11px; font-weight: 600; color: rgba(255,255,255,0.8); font-family: 'Poppins', sans-serif;">5</span>
                </div>
            </div>
        </div>
        <label>Color Picker</label><input type="color" value="#FF0000" id="c1">
        <label>Alfa: <span id="alphaValue-value">150</span></label>
        <input type="range" value="150" id="alphaValue" min="0" max ="255" step="1" class="jpslider" >
        <label>Size: <span id="size-value">20</span></label>
        <input type="range" value="20" id="size" min="0" max ="100" step="0.1" class="jpslider" >
        <label>Efecto Kaleido: <span id="kaleidoSegments-value">1</span></label>
        <input type="range" value="1" id="kaleidoSegments" min="1" max="16" step="1" class="jpslider">
        <div style="margin-top: 15px;"></div>
        <label>Brush Type</label>
        <div class="brush-selector">
            <button class="brush-btn active" data-brush="classic" title="Classic Circle">
                <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="8" fill="currentColor"/></svg>
            </button>
            <button class="brush-btn" data-brush="line" title="Line Brush">
                <svg viewBox="0 0 24 24"><line x1="4" y1="20" x2="20" y2="4" stroke="currentColor" stroke-width="3" stroke-linecap="round"/></svg>
            </button>
            <button class="brush-btn" data-brush="art" title="Art Brush">
                <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="2" fill="currentColor"/><circle cx="8" cy="8" r="1.5" fill="currentColor"/><circle cx="16" cy="8" r="1.5" fill="currentColor"/><circle cx="8" cy="16" r="1.5" fill="currentColor"/><circle cx="16" cy="16" r="1.5" fill="currentColor"/></svg>
            </button>
            <button class="brush-btn" data-brush="pixel" title="Pixel Brush">
                <svg viewBox="0 0 24 24"><rect x="4" y="4" width="6" height="6" fill="currentColor"/><rect x="14" y="4" width="6" height="6" fill="currentColor"/><rect x="4" y="14" width="6" height="6" fill="currentColor"/><rect x="14" y="14" width="6" height="6" fill="currentColor"/></svg>
            </button>
            <button class="brush-btn" data-brush="text" title="Text Brush">
                <svg viewBox="0 0 24 24"><text x="12" y="18" text-anchor="middle" font-size="16" font-weight="bold" fill="currentColor">A</text></svg>
            </button>
            <button class="brush-btn" data-brush="geometry" title="Geometry Brush">
                <svg viewBox="0 0 24 24"><polygon points="12,4 20,20 4,20" fill="currentColor"/></svg>
            </button>
            <button class="brush-btn" data-brush="fill" title="Fill/Bucket">
                <svg viewBox="0 0 24 24"><path d="M19,11.5C19,11.5 17,13.67 17,15A2,2 0 0,0 19,17A2,2 0 0,0 21,15C21,13.67 19,11.5 19,11.5M5.21,10L10,5.21L14.79,10M16.56,8.94L7.62,0L6.21,1.41L8.59,3.79L3.44,8.94C2.85,9.53 2.85,10.5 3.44,11.09L8.94,16.59C9.23,16.88 9.62,17 10,17C10.38,17 10.77,16.88 11.06,16.59L16.56,11.09C17.15,10.5 17.15,9.53 16.56,8.94Z" fill="currentColor"/></svg>
            </button>
            <button class="brush-btn" data-brush="image" title="Image Brush">
                <svg viewBox="0 0 24 24"><path fill="currentColor" d="M8.5,13.5L11,16.5L14.5,12L19,18H5M21,19V5C21,3.89 20.1,3 19,3H5A2,2 0 0,0 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19Z" /></svg>
            </button>
            <button class="brush-btn" data-brush="flower" title="Flower Brush">
                <svg viewBox="0 0 24 24">
                    <!-- P√©talos alrededor -->
                    <circle cx="12" cy="5" r="2.5" fill="currentColor"/>
                    <circle cx="18" cy="8.5" r="2.5" fill="currentColor"/>
                    <circle cx="19" cy="15.5" r="2.5" fill="currentColor"/>
                    <circle cx="12" cy="19" r="2.5" fill="currentColor"/>
                    <circle cx="5" cy="15.5" r="2.5" fill="currentColor"/>
                    <circle cx="6" cy="8.5" r="2.5" fill="currentColor"/>
                    <!-- Centro -->
                    <circle cx="12" cy="12" r="3" fill="currentColor"/>
                </svg>
            </button>
            <button class="brush-btn" data-brush="background" onClick="cleanBackground()" title="Limpiar Canvas">
                <svg viewBox="0 0 24 24">
                    <!-- Cuerpo de la bomba (m√°s ovalado) -->
                    <ellipse cx="12" cy="15.5" rx="7.5" ry="7" fill="currentColor"/>
                    
                    <!-- Pico/cuello de la bomba -->
                    <rect x="10.5" y="8" width="3" height="2" fill="currentColor" rx="0.5"/>
                    <ellipse cx="12" cy="8.5" rx="2" ry="1.2" fill="currentColor"/>
                    
                    <!-- Mecha curva saliendo del pico -->
                    <path d="M 12 8 Q 12.5 6, 13 4 Q 13.3 2.5, 14 1.5" stroke="currentColor" stroke-width="1.5" fill="none" stroke-linecap="round"/>
                    
                    <!-- Llama en la punta (fuego) -->
                    <ellipse cx="14" cy="1.2" rx="1.5" ry="2" fill="#FF4500" opacity="0.9"/>
                    <ellipse cx="14" cy="1" rx="1" ry="1.3" fill="#FFD700"/>
                    <ellipse cx="14.2" cy="0.8" rx="0.5" ry="0.7" fill="#FFF" opacity="0.8"/>
                    
                    <!-- Brillo principal en el cuerpo -->
                    <ellipse cx="9" cy="13" rx="2.5" ry="3" fill="white" opacity="0.3"/>
                    <!-- Brillo secundario -->
                    <circle cx="14" cy="17" r="1.2" fill="white" opacity="0.15"/>
                </svg>
            </button>
        </div>
        <input type="hidden" id="brushType" value="classic">
        <br>
        <!-- Classic Brush Controls -->
        <div id="classicBrushParams" class="brushParams" style="display: none;">
            <!-- No additional controls for classic brush -->
        </div>
        
        <!-- Pixel Brush Controls -->
        <div id="pixelBrushParams" class="brushParams" style="display: none;">
            <label>Grid Columns: <span id="gridCols-value">32</span></label>
            <input type="range" value="32" id="gridCols" min="4" max="64" step="4" class="jpslider">
            <br>
            <label>Grid Rows: <span id="gridRows-value">32</span></label>
            <input type="range" value="32" id="gridRows" min="4" max="64" step="4" class="jpslider">
            <br>
            <label>Show Grid</label>
            <input type="checkbox" id="showGrid" class="jpcheckbox">
            <br>
        </div>
        
        <!-- Art Brush Controls -->
        <div id="artBrushParams" class="brushParams" style="display: none;">
            <label>Particle Count: <span id="particleCount-value">10</span></label>
            <input type="range" value="10" id="particleCount" min="1" max="30" step="1" class="jpslider">
            <br>
            <label>Speed Force: <span id="speedForce-value">0.5</span></label>
            <input type="range" value="0.5" id="speedForce" min="0.1" max="2.0" step="0.1" class="jpslider">
            <br>
            <label>Max Speed: <span id="maxSpeed-value">0.5</span></label>
            <input type="range" value="0.5" id="maxSpeed" min="0.1" max="3.0" step="0.1" class="jpslider">
            <br>
            <label>Life: <span id="particleLife-value">255</span></label>
            <input type="range" value="255" id="particleLife" min="50" max="1000" step="10" class="jpslider">
            <br>
            <label>Particle Size: <span id="particleMaxSize-value">8</span></label>
            <input type="range" value="8" id="particleMaxSize" min="1" max="20" step="1" class="jpslider">
            <br>
            <h4 style="margin-top: 15px; margin-bottom: 10px; color: var(--text); font-size: 0.95rem;">Flowfield</h4>
            <label>Activate Flowfield</label>
            <input type="checkbox" id="activateFlowfield" class="jpcheckbox" onchange="toggleFlowfield()">
            <br>
            <div id="flowfieldControls" style="display: none;">
                <label>Show Flowfield</label>
                <input type="checkbox" id="showFlowfield" class="jpcheckbox" onchange="updateFlowfieldConfig(false)">
                <br>
                <label>Flowfield Cols: <span id="flowfieldCols-value">20</span></label>
                <input type="range" value="20" id="flowfieldCols" min="5" max="50" step="1" class="jpslider" oninput="updateFlowfieldConfig()">
                <br>
                <label>Flowfield Rows: <span id="flowfieldRows-value">20</span></label>
                <input type="range" value="20" id="flowfieldRows" min="5" max="50" step="1" class="jpslider" oninput="updateFlowfieldConfig()">
                <br>
                <label>Flowfield Strength: <span id="flowfieldStrength-value">0.1</span></label>
                <input type="range" value="0.1" id="flowfieldStrength" min="0" max="1" step="0.05" class="jpslider" oninput="updateFlowfieldConfig()">
                <br>
                <label>Flowfield Speed: <span id="flowfieldSpeed-value">0.003</span></label>
                <input type="range" value="0.003" id="flowfieldSpeed" min="0" max="0.02" step="0.001" class="jpslider" oninput="updateFlowfieldConfig()">
                <br>
                <button onclick="sendFlowfieldSync()" style="margin-top: 10px; padding: 8px 15px; background: var(--accent); color: var(--bg); border: none; border-radius: 5px; cursor: pointer; font-size: 0.9rem;">
                    Sincronizar Flowfield
                </button>
                <br>
            </div>
        </div>
        
        <!-- Text Brush Controls -->
        <div id="textBrushParams" class="brushParams" style="display: none;">
            <label>Text</label>
            <input type="text" id="textContent" value="TEXTO" class="jpinput" style="width: 90%; padding: 5px; margin-bottom: 5px;">
            <br>
            <label>Font</label>
            <select id="textFont" class="jpselect">
                <option value="Arial">Arial</option>
                <option value="Roboto">Roboto</option>
                <option value="Montserrat">Montserrat</option>
                <option value="Lato">Lato</option>
                <option value="Open Sans">Open Sans</option>
                <option value="Poppins">Poppins</option>
                <option value="Dancing Script">Dancing Script</option>
                <option value="Pacifico">Pacifico</option>
                <option value="Indie Flower">Indie Flower</option>
                <option value="Shadows Into Light">Shadows Into Light</option>
                <option value="Permanent Marker">Permanent Marker</option>
                <option value="Caveat">Caveat</option>
                <option value="Satisfy">Satisfy</option>
                <option value="Quicksand">Quicksand</option>
                <option value="Comfortaa">Comfortaa</option>
                <option value="Josefin Sans">Josefin Sans</option>
            </select>
            <br>
            <p style="font-size: 0.85rem; color: rgba(255,255,255,0.7); margin-top: 5px;">
                üí° Usa el slider de Tama√±o general para ajustar el tama√±o del texto
            </p>
        </div>
        
        <!-- Spirograph Brush Controls -->
        <div id="geometryBrushParams" class="brushParams" style="display: none;">
            <p style="font-size: 0.85rem; color: rgba(255,255,255,0.7); margin-bottom: 10px;">
                üí° El tama√±o del brush controla el radio principal
            </p>
            <label>M√≥dulo: <span id="spiroModulo-value">30</span></label>
            <input type="range" value="30" id="spiroModulo" min="5" max="300" step="5" class="jpslider"
                   oninput="document.getElementById('spiroModulo-value').textContent = this.value">
            <br>
            <label>Velocidad Rotaci√≥n: <span id="spiroInc-value">2</span></label>
            <input type="range" value="2" id="spiroInc" min="0.1" max="10" step="0.1" class="jpslider"
                   oninput="document.getElementById('spiroInc-value').textContent = this.value">
            <br>
            <label>Radio 2 (Estrella): <span id="radius2-value">0.6</span></label>
            <input type="range" value="0.6" id="radius2" min="0.1" max="2" step="0.1" class="jpslider"
                   oninput="document.getElementById('radius2-value').textContent = this.value">
            <br>
            <label>Puntas: <span id="npoints1-value">5</span></label>
            <input type="range" value="5" id="npoints1" min="3" max="12" step="1" class="jpslider"
                   oninput="document.getElementById('npoints1-value').textContent = this.value">
            <br>
            <label>Escala Borde: <span id="borderScale-value">1.1</span></label>
            <input type="range" value="1.1" id="borderScale" min="1" max="2" step="0.05" class="jpslider"
                   oninput="document.getElementById('borderScale-value').textContent = this.value">
            <br>
            <label>Alpha Borde: <span id="borderAlpha-value">255</span></label>
            <input type="range" value="255" id="borderAlpha" min="0" max="255" step="5" class="jpslider"
                   oninput="document.getElementById('borderAlpha-value').textContent = this.value">
        </div>
        
        <!-- Fill Brush Controls -->
        <div id="fillBrushParams" class="brushParams" style="display: none;">
            <label>Tolerance: <span id="fillTolerance-value">0</span></label>
            <input type="range" value="0" id="fillTolerance" min="0" max="50" step="1" class="jpslider">
            <br>
            <p style="font-size: 0.85rem; color: rgba(255,255,255,0.7); margin-top: 5px;">
                üí° Tolerance: 0 = solo color exacto, mayor = colores similares
            </p>
        </div>
        
        <!-- Flower Brush Controls -->
        <div id="flowerBrushParams" class="brushParams" style="display: none;">
            <p style="font-size: 0.85rem; color: rgba(255,255,255,0.7); margin-bottom: 10px;">
                üí° Tama√±o m√≠nimo fijo en 1
            </p>
            <label>Tama√±o M√°ximo: <span id="maxSize-value">14</span></label>
            <input type="range" value="14" id="maxSize" min="10" max="50" step="1" class="jpslider"
                   oninput="document.getElementById('maxSize-value').textContent = this.value">
            <br>
            <label>Frecuencia: <span id="frequency-value">6</span></label>
            <input type="range" value="6" id="frequency" min="3" max="12" step="1" class="jpslider"
                   oninput="document.getElementById('frequency-value').textContent = this.value">
            <br>
            <label>Velocidad Anim: <span id="animSpeed-value">0.10</span></label>
            <input type="range" value="0.1" id="animSpeed" min="0" max="0.15" step="0.005" class="jpslider"
                   oninput="document.getElementById('animSpeed-value').textContent = parseFloat(this.value).toFixed(2)">
            <br>
            <label>Grosor Trazo: <span id="flowerStrokeWeight-value">4</span></label>
            <input type="range" value="4" id="flowerStrokeWeight" min="1" max="5" step="1" class="jpslider"
                   oninput="document.getElementById('flowerStrokeWeight-value').textContent = this.value">
            <br>
            <label>Alpha Trazo: <span id="strokeAlpha-value">45</span></label>
            <input type="range" value="45" id="strokeAlpha" min="5" max="100" step="5" class="jpslider"
                   oninput="document.getElementById('strokeAlpha-value').textContent = this.value">
            <br>
            <label>Velocidad Encogimiento: <span id="shrinkSpeed-value">0.15</span></label>
            <input type="range" value="0.15" id="shrinkSpeed" min="0" max="2" step="0.01" class="jpslider"
                   oninput="document.getElementById('shrinkSpeed-value').textContent = parseFloat(this.value).toFixed(2)">
            <br>
            <label>Offset Sombra: <span id="shadowOffset-value">10</span></label>
            <input type="range" value="10" id="shadowOffset" min="0" max="15" step="1" class="jpslider"
                   oninput="document.getElementById('shadowOffset-value').textContent = this.value">
        </div>
        
        <!-- Image Brush Controls -->
        <div id="imageBrushParams" class="brushParams" style="display: none;">
            <h4 style="margin-top: 0; margin-bottom: 10px; color: var(--text); font-size: 0.95rem;">Emojis Presets</h4>
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 15px;">
                <button onclick="loadEmojiPreset('üòÄ')" class="emoji-preset-btn" title="Cara Feliz">üòÄ</button>
                <button onclick="loadEmojiPreset('‚ù§Ô∏è')" class="emoji-preset-btn" title="Coraz√≥n">‚ù§Ô∏è</button>
                <button onclick="loadEmojiPreset('‚≠ê')" class="emoji-preset-btn" title="Estrella">‚≠ê</button>
                <button onclick="loadEmojiPreset('üî•')" class="emoji-preset-btn" title="Fuego">üî•</button>
                <button onclick="loadEmojiPreset('‚ú®')" class="emoji-preset-btn" title="Brillos">‚ú®</button>
                <button onclick="loadEmojiPreset('üé®')" class="emoji-preset-btn" title="Paleta">üé®</button>
                <button onclick="loadEmojiPreset('üåà')" class="emoji-preset-btn" title="Arco√≠ris">üåà</button>
                <button onclick="loadEmojiPreset('ü¶ã')" class="emoji-preset-btn" title="Mariposa">ü¶ã</button>
                <button onclick="loadEmojiPreset('üå∏')" class="emoji-preset-btn" title="Flor">üå∏</button>
                <button onclick="loadEmojiPreset('üçï')" class="emoji-preset-btn" title="Pizza">üçï</button>
                <button onclick="loadEmojiPreset('üé≠')" class="emoji-preset-btn" title="Teatro">üé≠</button>
                <button onclick="loadEmojiPreset('üé™')" class="emoji-preset-btn" title="Circo">üé™</button>
            </div>
            
            <h4 style="margin-top: 15px; margin-bottom: 10px; color: var(--text); font-size: 0.95rem;">Buscador de Im√°genes</h4>
            <div style="display: flex; gap: 5px; margin-bottom: 10px; align-items: stretch;">
                <input type="text" id="imageSearchInput" placeholder="Buscar im√°genes..." class="jpinput" style="flex: 1; padding: 8px;">
                <button onclick="searchImages()" style="padding: 0 12px; background: var(--accent); color: var(--bg); border: none; border-radius: 5px; cursor: pointer; font-weight: 600; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; min-width: 44px;">
                    üîç
                </button>
            </div>
            <div id="imageSearchResults" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 15px; max-height: 200px; overflow-y: auto;">
                <!-- Resultados de b√∫squeda aparecer√°n aqu√≠ -->
            </div>
            
            <h4 style="margin-top: 15px; margin-bottom: 10px; color: var(--text); font-size: 0.95rem;">Mis Im√°genes Guardadas</h4>
            <div id="savedImagesContainer" style="margin-bottom: 15px;">
                <p style="font-size: 0.8rem; color: rgba(255,255,255,0.5); text-align: center;">No hay im√°genes guardadas</p>
            </div>
            
            <h4 style="margin-top: 15px; margin-bottom: 10px; color: var(--text); font-size: 0.95rem;">Cargar Imagen</h4>
            <input type="file" id="imageBrushFile" accept="image/*" onchange="handleImageBrushFileUpload()" class="jpinput" style="width: 90%; padding: 5px; margin-bottom: 10px;">
            <br>
            <div style="text-align: center; margin: 10px 0;">
                <img id="imageBrushPreview" style="display: none; max-width: 100px; max-height: 100px; border: 2px solid var(--accent); border-radius: 5px;" />
            </div>
            <button onclick="clearImageBrush()" style="width: 100%; padding: 8px; background: rgba(244, 67, 54, 0.8); color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 0.9rem; margin-top: 5px;">
                Limpiar Imagen
            </button>
            <p style="font-size: 0.85rem; color: rgba(255,255,255,0.7); margin-top: 10px;">
                üí° La imagen se redimensiona a 50x50. El dibujo se sincroniza pero tu selecci√≥n de emoji es personal
            </p>
        </div>
        
        <!-- Sistema de Capas Din√°mico -->
        <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.2);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <label>Sistema de Capas</label>
                <button onclick="addLayer()" class="btn-add-layer" title="Agregar Capa">+</button>
            </div>
            
            <!-- Contenedor din√°mico de capas -->
            <div id="layersContainer"></div>
        </div>
        
        <!-- Botones de descarga y guardado al final -->
        <div style="margin-top: 10px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.2);">
            <label style="margin-bottom: 10px;">Guardar Imagen</label>
            <div class="socket-buttons">
                <button id="downloadButton" class="socket-btn square active" onClick="downloadImage()" title="Download Image">
                    <svg viewBox="0 0 24 24">
                        <path fill="white" d="M5,20H19V18H5M19,9H15V3H9V9H5L12,16L19,9Z" />
                    </svg>
                </button>
                <button id="saveButton" class="socket-btn square active" onClick="saveImageToServer()" title="Save to Gallery">
                    <svg viewBox="0 0 24 24">
                        <path fill="white" d="M15,9H5V5H15M12,19A3,3 0 0,1 9,16A3,3 0 0,1 12,13A3,3 0 0,1 15,16A3,3 0 0,1 12,19M17,3H5C3.89,3 3,3.9 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V7L17,3Z" />
                    </svg>
                </button>
            </div>
            
            <!-- Bot√≥n FPS -->
            <button id="toggleFPSBtn" onclick="toggleFPS()" style="width: 100%; padding: 10px; margin-top: 10px; background: rgba(138, 79, 191, 0.8); color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 0.9rem; font-weight: 600;">
                Show FPS
            </button>
        </div>
        </div>
        
        <!-- Contenido de la pesta√±a: About -->
        <div id="tab-about" class="tab-content">
        <div class="about-section">
            <h4>About PizarraCollab</h4>
            <p style="font-size: 0.85rem; line-height: 1.4; color: rgba(255,255,255,0.85);">
                PizarraCollab es una pizarra colaborativa en tiempo real que permite a m√∫ltiples usuarios dibujar juntos desde cualquier lugar del mundo. 
                Creado por <strong>JPupper</strong>, este proyecto combina arte, tecnolog√≠a y colaboraci√≥n.
            </p>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <a href="gallery.html" target="_blank" class="about-link">
                    üñºÔ∏è Ver Galer√≠a Global
                </a>
                <a href="https://jeyder.com.ar/jpupper/" target="_blank" class="about-link">
                    üåê Visitar sitio web
                </a>
            </div>
        </div>
        </div>
        
        <!-- Contenido de la pesta√±a: Chat -->
        <div id="tab-chat" class="tab-content">
        <div class="chat-section">
            <h4>Chat en Vivo</h4>
            
            <!-- Informaci√≥n de la sesi√≥n -->
            <div id="sessionInfo" style="margin-bottom: 15px; padding: 12px; background: linear-gradient(135deg, rgba(102, 126, 234, 0.15) 0%, rgba(118, 75, 162, 0.15) 100%); border-radius: 8px; border-left: 3px solid #667eea; display: none;">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                    <svg viewBox="0 0 24 24" width="18" height="18" style="fill: #667eea;">
                        <path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4M11,7V13H13V7H11M11,15V17H13V15H11Z"/>
                    </svg>
                    <strong id="sessionInfoName" style="color: rgba(255,255,255,0.95); font-size: 0.95rem;"></strong>
                </div>
                <p id="sessionInfoDescription" style="margin: 0; color: rgba(255,255,255,0.7); font-size: 0.85rem; line-height: 1.4;"></p>
            </div>
            
            <!-- Selector de sesi√≥n y botones en la misma l√≠nea -->
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                <div style="flex: 1;">
                    <label for="sessionInput" style="color: rgba(255,255,255,0.8); font-size: 0.85rem; margin-bottom: 5px; display: block;">Sesi√≥n:</label>
                    <input type="text" id="sessionInput" class="jpinput session-input" style="width: 100%;">
                </div>
                <div style="display: flex; gap: 8px;">
                    <button id="toggleReceive" class="socket-btn square active" title="Recibir Sockets">
                        <svg viewBox="0 0 24 24">
                            <path fill="white" d="M12,1C7,1 3,5 3,10V17A3,3 0 0,0 6,20H9V12H5V10A7,7 0 0,1 12,3A7,7 0 0,1 19,10V12H15V20H18A3,3 0 0,0 21,17V10C21,5 16.97,1 12,1Z" />
                            <g class="headphone-disabled" style="display:none;">
                                <path fill="none" d="M2,4L22,22" stroke="white" stroke-width="2.5" />
                            </g>
                        </svg>
                    </button>
                    <button id="toggleSend" class="socket-btn square active" title="Enviar Sockets">
                        <svg viewBox="0 0 24 24" class="eye-icon">
                            <path class="eye-open" fill="white" d="M12,9A3,3 0 0,0 9,12A3,3 0 0,0 12,15A3,3 0 0,0 15,12A3,3 0 0,0 12,9M12,17A5,5 0 0,1 7,12A5,5 0 0,1 12,7A5,5 0 0,1 17,12A5,5 0 0,1 12,17M12,4.5C7,4.5 2.73,7.61 1,12C2.73,16.39 7,19.5 12,19.5C17,19.5 21.27,16.39 23,12C21.27,7.61 17,4.5 12,4.5Z" />
                            <path class="eye-closed" fill="white" d="M11.83,9L15,12.16C15,12.11 15,12.05 15,12A3,3 0 0,0 12,9C11.94,9 11.89,9 11.83,9M7.53,9.8L9.08,11.35C9.03,11.56 9,11.77 9,12A3,3 0 0,0 12,15C12.22,15 12.44,14.97 12.65,14.92L14.2,16.47C13.53,16.8 12.79,17 12,17A5,5 0 0,1 7,12C7,11.21 7.2,10.47 7.53,9.8M2,4.27L4.28,6.55L4.73,7C3.08,8.3 1.78,10 1,12C2.73,16.39 7,19.5 12,19.5C13.55,19.5 15.03,19.2 16.38,18.66L16.81,19.08L19.73,22L21,20.73L3.27,3M12,7A5,5 0 0,1 17,12C17,12.64 16.87,13.26 16.64,13.82L19.57,16.75C21.07,15.5 22.27,13.86 23,12C21.27,7.61 17,4.5 12,4.5C10.6,4.5 9.26,4.75 8,5.2L10.17,7.35C10.74,7.13 11.35,7 12,7Z" style="display:none;" />
                        </svg>
                    </button>
                </div>
            </div>
            
            <!-- Contador de cursores -->
            <div id="cursorCount" class="cursor-counter" style="text-align: center; padding: 8px; background-color: rgba(138, 79, 191, 0.2); border-radius: 5px; margin-bottom: 10px; color: rgba(255,255,255,0.9); font-size: 0.9rem;">Cursores: 0</div>
            
            <!-- Lista de usuarios conectados -->
            <div style="margin-bottom: 15px; padding: 10px; background-color: rgba(138, 79, 191, 0.15); border-radius: 8px;">
                <h5 style="margin: 0 0 8px 0; color: rgba(255,255,255,0.8); font-size: 0.85rem;">Usuarios Conectados:</h5>
                <div id="connectedUsersList" style="display: flex; flex-wrap: wrap; gap: 6px; min-height: 30px;">
                    <span style="color: rgba(255,255,255,0.5); font-size: 0.8rem;">Cargando...</span>
                </div>
            </div>
            
            <div class="chat-user-info" style="margin-bottom: 10px; padding: 8px; background-color: rgba(138, 79, 191, 0.2); border-radius: 5px;">
                <span style="color: rgba(255,255,255,0.7);">Tu nombre: </span>
                <span id="chatUsername" style="color: var(--accent); font-weight: bold;">Cargando...</span>
            </div>
            <div id="chatMessages" class="chat-messages"></div>
            <div class="chat-input-container">
                <input type="text" id="chatInput" class="chat-input" placeholder="Escribe un mensaje...">
                <button id="sendChatBtn" class="chat-send-btn">
                    <svg viewBox="0 0 24 24" width="20" height="20">
                        <path fill="white" d="M2,21L23,12L2,3V10L17,12L2,14V21Z"/>
                    </svg>
                </button>
            </div>
        </div>
        </div>
        
        <!-- Contenido de la pesta√±a: User -->
        <div id="tab-user" class="tab-content">
        <div class="user-section">
            <h4>Mi Cuenta</h4>
            <div id="userNotLoggedIn" style="display: none;">
                <p style="color: rgba(255,255,255,0.8); margin-bottom: 15px;">
                    Inicia sesi√≥n para guardar tus dibujos
                </p>
                <a href="login.html" class="btn-user-action" style="display: inline-block; padding: 10px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; text-decoration: none; border-radius: 8px; font-weight: 600; margin-right: 10px;">
                    Iniciar Sesi√≥n
                </a>
                <a href="register.html" class="btn-user-action" style="display: inline-block; padding: 10px 20px; background: rgba(255,255,255,0.1); color: white; text-decoration: none; border-radius: 8px; font-weight: 600;">
                    Registrarse
                </a>
            </div>
            <div id="userLoggedIn" style="display: none;">
                <div style="background: rgba(138, 79, 191, 0.2); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <p style="color: rgba(255,255,255,0.7); margin: 0 0 5px 0;">Usuario:</p>
                    <p id="loggedUsername" style="color: var(--accent); font-weight: bold; font-size: 1.2rem; margin: 0;">Cargando...</p>
                </div>
                <a href="profile.html" class="btn-user-action" style="display: inline-block; padding: 10px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; text-decoration: none; border-radius: 8px; font-weight: 600; margin-bottom: 10px; width: 100%; text-align: center; box-sizing: border-box;">
                    Ver Mi Galer√≠a
                </a>
                <button onclick="shareSession()" class="btn-user-action" style="display: block; padding: 10px 20px; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; width: 100%; margin-bottom: 10px;">
                    üì§ Share
                </button>
                <button onclick="logoutUser()" class="btn-user-action" style="display: block; padding: 10px 20px; background: rgba(244, 67, 54, 0.8); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; width: 100%;">
                    Cerrar Sesi√≥n
                </button>
            </div>
            
            <!-- QR Configuration -->
            <div style="margin-top: 20px; padding: 15px; background: rgba(0, 0, 0, 0.3); border-radius: 8px;">
                <h4 style="margin-top: 0; margin-bottom: 15px;">‚öôÔ∏è QR Configuration</h4>
                <div style="margin-bottom: 10px;">
                    <label>Posici√≥n X: <span id="qrX-value">50</span></label>
                    <input type="range" value="50" id="qrX" min="0" max="100" step="1" class="jpslider"
                           oninput="document.getElementById('qrX-value').textContent = this.value">
                </div>
                <div style="margin-bottom: 10px;">
                    <label>Posici√≥n Y: <span id="qrY-value">50</span></label>
                    <input type="range" value="50" id="qrY" min="0" max="100" step="1" class="jpslider"
                           oninput="document.getElementById('qrY-value').textContent = this.value">
                </div>
                <div style="margin-bottom: 10px;">
                    <label>Escala: <span id="qrScale-value">1</span></label>
                    <input type="range" value="1" id="qrScale" min="0.5" max="3" step="0.1" class="jpslider"
                           oninput="document.getElementById('qrScale-value').textContent = this.value">
                </div>
                <div style="display: flex; gap: 10px;">
                    <button onclick="toggleQR()" id="qrToggleBtn" class="btn-user-action" style="flex: 1; padding: 10px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                        Mostrar QR
                    </button>
                    <button onclick="copySessionLink()" class="btn-user-action" style="flex: 1; padding: 10px 20px; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                        üìã Copiar Link
                    </button>
                </div>
            </div>
        </div>
        </div>
        
        <!-- Bot√≥n de cerrar (fuera de las pesta√±as) -->
        <button id="closeButton" class="close-button">
            <svg viewBox="0 0 24 24">
                <path fill="currentColor" d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z"/>
            </svg>
        </button>
    </div>
    
    <button id="opengui" class="animated-button" onClick="openGui()">
        <svg viewBox="0 0 24 24">
            <path fill="currentColor" d="M3,6H21V8H3V6M3,11H21V13H3V11M3,16H21V18H3V16Z"/>
        </svg>
    </button>
    
    <!-- Controles de Zoom -->
    <div id="zoom-controls" style="position: fixed; bottom: 20px; right: 20px; z-index: 1000; display: flex; flex-direction: column; gap: 8px;">
        <button onclick="zoomIn()" class="zoom-btn" title="Zoom In (Ctrl + Scroll Up)">
            <svg viewBox="0 0 24 24" width="20" height="20">
                <path fill="currentColor" d="M15.5,14L20.5,19L19,20.5L14,15.5V14.71L13.73,14.43C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.43,13.73L14.71,14H15.5M9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14M12,10H10V12H9V10H7V9H9V7H10V9H12V10Z"/>
            </svg>
        </button>
        <button onclick="resetZoom()" class="zoom-btn" title="Reset Zoom (100%)">
            <svg viewBox="0 0 24 24" width="20" height="20">
                <path fill="currentColor" d="M12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,12.5A0.5,0.5 0 0,1 11.5,12A0.5,0.5 0 0,1 12,11.5A0.5,0.5 0 0,1 12.5,12A0.5,0.5 0 0,1 12,12.5M7.5,12A0.5,0.5 0 0,1 7,11.5A0.5,0.5 0 0,1 7.5,11A0.5,0.5 0 0,1 8,11.5A0.5,0.5 0 0,1 7.5,12M16.5,12A0.5,0.5 0 0,1 16,11.5A0.5,0.5 0 0,1 16.5,11A0.5,0.5 0 0,1 17,11.5A0.5,0.5 0 0,1 16.5,12Z"/>
            </svg>
        </button>
        <button onclick="zoomOut()" class="zoom-btn" title="Zoom Out (Ctrl + Scroll Down)">
            <svg viewBox="0 0 24 24" width="20" height="20">
                <path fill="currentColor" d="M15.5,14L20.5,19L19,20.5L14,15.5V14.71L13.73,14.43C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.43,13.73L14.71,14H15.5M9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14M7,9H12V10H7V9Z"/>
            </svg>
        </button>
    </div>
    
    <!-- Modal para guardar imagen -->
    <div id="saveImageModal" class="save-modal">
        <div class="save-modal-content">
            <button class="save-modal-close" onclick="closeSaveModal()">√ó</button>
            <h2>üíæ Guardar tu Obra de Arte</h2>
            <form id="saveImageForm" onsubmit="submitSaveImage(event)">
                <div class="form-group">
                    <label for="imageTitle">T√≠tulo *</label>
                    <input type="text" id="imageTitle" required placeholder="Ej: Atardecer Abstracto" maxlength="100">
                </div>
                <div class="form-group">
                    <label for="imageDescription">Descripci√≥n</label>
                    <textarea id="imageDescription" placeholder="Cu√©ntanos sobre tu creaci√≥n..." rows="4" maxlength="500"></textarea>
                    <small id="charCount">0/500 caracteres</small>
                </div>
                <div class="collaborators-info">
                    <h4> Colaboradores en esta sesi√≥n:</h4>
                    <div id="collaboratorsList">Cargando...</div>
                </div>
                <div class="form-group" style="margin-top: 15px;">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; font-size: 0.95rem;">
                        <input type="checkbox" id="saveOnlyFinal" checked style="width: 18px; height: 18px; cursor: pointer;">
                        <span> Guardar solo imagen final (sin capas individuales)</span>
                    </label>
                    <small style="display: block; margin-top: 5px; color: rgba(255,255,255,0.6); margin-left: 28px;">
                        Desmarca si quieres guardar tambi√©n las capas individuales
                    </small>
                </div>
                <div class="save-modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeSaveModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar Imagen</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal de bienvenida -->
    <div id="welcomeModal" class="welcome-modal">
        <div class="welcome-modal-content">
            <button class="welcome-modal-close" onclick="closeWelcomeModal()">√ó</button>
            <div class="welcome-header">
                <h1>üé® PizarraCollab</h1>
                <p class="welcome-subtitle">Dibujo colaborativo en tiempo real</p>
            </div>
            <div class="welcome-actions">
                <a href="login.html" class="welcome-btn welcome-btn-primary">
                    <svg viewBox="0 0 24 24" width="20" height="20">
                        <path fill="currentColor" d="M10,17V14H3V10H10V7L15,12L10,17M10,2H19A2,2 0 0,1 21,4V20A2,2 0 0,1 19,22H10A2,2 0 0,1 8,20V18H10V20H19V4H10V6H8V4A2,2 0 0,1 10,2Z"/>
                    </svg>
                    Login
                </a>
                <a href="register.html" class="welcome-btn welcome-btn-secondary">
                    <svg viewBox="0 0 24 24" width="20" height="20">
                        <path fill="currentColor" d="M15,14C12.33,14 7,15.33 7,18V20H23V18C23,15.33 17.67,14 15,14M6,10V7H4V10H1V12H4V15H6V12H9V10M15,12A4,4 0 0,0 19,8A4,4 0 0,0 15,4A4,4 0 0,0 11,8A4,4 0 0,0 15,12Z"/>
                    </svg>
                    Register
                </a>
            </div>
            <p class="welcome-footer">o contin√∫a sin cuenta para dibujar libremente</p>
            
            <div class="welcome-explore-section">
                <p class="welcome-explore-title">Explora m√°s:</p>
                <div class="welcome-explore-links">
                    <a href="gallery.html" class="welcome-link welcome-link-primary">
                        <svg viewBox="0 0 24 24" width="18" height="18">
                            <path fill="currentColor" d="M22,16V4A2,2 0 0,0 20,2H8A2,2 0 0,0 6,4V16A2,2 0 0,0 8,18H20A2,2 0 0,0 22,16M11,12L13.03,14.71L16,11L20,16H8M2,6V20A2,2 0 0,0 4,22H18V20H4V6"/>
                        </svg>
                        Galer√≠a Global
                    </a>
                    <a href="profile.html" class="welcome-link welcome-link-secondary">
                        <svg viewBox="0 0 24 24" width="18" height="18">
                            <path fill="currentColor" d="M12,4A4,4 0 0,1 16,8A4,4 0 0,1 12,12A4,4 0 0,1 8,8A4,4 0 0,1 12,4M12,14C16.42,14 20,15.79 20,18V20H4V18C4,15.79 7.58,14 12,14Z"/>
                        </svg>
                        Mi Perfil
                    </a>
                </div>
            </div>
        </div>
    </div>
    
  <script src="js/toast.js"></script>
  <script src="js/general.js"></script>
  </body>
</html>
